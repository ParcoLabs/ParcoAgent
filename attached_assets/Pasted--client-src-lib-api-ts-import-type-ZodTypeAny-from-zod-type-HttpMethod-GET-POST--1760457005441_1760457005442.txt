// client/src/lib/api.ts
import type { ZodTypeAny } from "zod";

type HttpMethod = "GET" | "POST" | "PUT" | "PATCH" | "DELETE";

export const BASE: string =
  (import.meta as any)?.env?.VITE_API_BASE_URL?.toString().replace(/\/$/, "") || "/api";

/* -------------------------------------------------------------------------- */
/* low-level                                                                  */
/* -------------------------------------------------------------------------- */
export async function api<T = unknown>(
  path: string,
  opts: { method?: HttpMethod; body?: any; headers?: Record<string, string> } = {}
): Promise<T> {
  const url = `${BASE}${normalizePath(path)}`;
  const headers: Record<string, string> = {
    ...(opts.body ? { "Content-Type": "application/json" } : {}),
    ...(import.meta.env.VITE_API_KEY ? { "x-api-key": String(import.meta.env.VITE_API_KEY) } : {}),
    ...(opts.headers || {}),
  };
  const res = await fetch(url, {
    method: opts.method || "GET",
    headers,
    body: opts.body ? JSON.stringify(opts.body) : undefined,
  });
  if (!res.ok) throw new Error((await safeText(res)) || res.statusText || `HTTP ${res.status}`);
  if (res.status === 204) return undefined as T;
  return (await safeJson(res)) as T;
}

export async function get<T = unknown>(path: string, schema?: ZodTypeAny): Promise<T> {
  const res = await fetch(`${BASE}${normalizePath(path)}`, { headers: baseHeaders(), method: "GET" });
  if (!res.ok) throw new Error(await res.text());
  const data = (await res.json()) as T;
  return schema ? (schema.parse(data) as T) : data;
}

export async function post<T = unknown>(path: string, body?: any): Promise<T> {
  return api<T>(path, { method: "POST", body });
}

/** TanStack Query global fn (queryKey[0] must be string path) */
export async function queryFn<T = unknown>({ queryKey }: { queryKey: any }): Promise<T> {
  const [path] = queryKey as [string, any?];
  if (typeof path !== "string") throw new Error("First queryKey entry must be a string path.");
  return api<T>(path);
}

/* -------------------------------------------------------------------------- */
/* types used by UI                                                           */
/* -------------------------------------------------------------------------- */
export type DraftChannel = "EMAIL" | "SMS" | "email" | "sms";
export type DraftStatusUI = "DRAFT" | "SENT" | "FAILED" | "PENDING";
export type DraftKind = "tenant_reply" | "vendor_outreach" | string;

export type Draft = {
  id: string;
  requestId: string;
  kind?: DraftKind;
  channel: DraftChannel;
  to: string;
  subject?: string | null;
  body: string;
  status: DraftStatusUI;
  createdAt: string;
  updatedAt?: string;
};

export type RequestLite = {
  id: string;
  title?: string;
  description?: string;
  propertyId?: string;
  status?: string;
  createdAt?: string;
  tenantName?: string;
  property?: string;
  category?: "Plumbing" | "Electrical" | "HVAC" | "Noise" | "Other";
  priority?: "Low" | "Medium" | "High" | "Urgent";
  slaDueAt?: string;
  summary?: string;
  vendorId?: string;
};

export type Vendor = {
  id: string;
  name: string;
  email?: string | null;
  phone?: string | null;
  category?: string | null;
};

export type DashboardStats = {
  activeRequests: number;
  urgentIssues: number;
  slaCompliance: number;
  avgResolutionDays: number;
};

export type SlaAlert = {
  id: string;
  propertyAddress: string;
  category: string;
  priority: string;
  hoursLeft: number;
};

/* -------------------------------------------------------------------------- */
/* adapters (requests/drafts/vendors/dashboard/agent/jobs/compose)            */
/* -------------------------------------------------------------------------- */

// Requests
export async function apiListRequests(): Promise<RequestLite[]> {
  return get<RequestLite[]>("/requests");
}

// Drafts
export async function apiListDrafts(): Promise<Draft[]> {
  const rows = await get<any[]>("/drafts");
  return rows.map((d) => {
    const ch = String(d.channel ?? "").toUpperCase();
    const st = String(d.status ?? "").toUpperCase();
    return {
      ...d,
      channel: ch === "EMAIL" || ch === "SMS" ? ch : ("EMAIL" as DraftChannel),
      status: st === "SENT" || st === "FAILED" ? st : ("DRAFT" as DraftStatusUI),
      createdAt: d.createdAt ?? new Date().toISOString(),
    } as Draft;
  });
}
// some parts of the UI import this name; make it available
export const apiListAgentDrafts = apiListDrafts;

// Run agent (default BOTH so the single Run button keeps behavior)
export async function apiRunAgent(
  requestId: string,
  mode: "tenant_update" | "vendor_outreach" | "both" = "both"
): Promise<{ ok: boolean; created: number; mode?: string }> {
  return post("/agent/run", { requestId, mode });
}

// Approve & send
export async function apiApproveDraft(draftId: string): Promise<{ ok: boolean } | { ok: true; sent: true }> {
  return post(`/agent/drafts/${draftId}/approve`);
}

// Assign vendor
export async function apiAssignVendor(
  requestId: string,
  vendorId: string,
  note?: string
): Promise<{ ok: boolean; requestId?: string; vendorId?: string; job?: any; result?: any }> {
  return post(`/requests/${requestId}/assign-vendor`, { vendorId, note });
}

// Vendors
export async function apiListVendors(): Promise<Vendor[]> {
  return get<Vendor[]>("/vendors");
}

// Dashboard
export async function apiDashboardStats(): Promise<DashboardStats> {
  return get<DashboardStats>("/dashboard/stats");
}
export async function apiSlaAlerts(): Promise<SlaAlert[]> {
  return get<SlaAlert[]>("/sla-alerts");
}
export async function apiNotifications(): Promise<any[]> {
  return get<any[]>("/notifications");
}
export async function apiCategoryDistribution(): Promise<Array<{ category: string; percentage: number }>> {
  return get("/category-distribution");
}

/* ------------------------------- Vendor Jobs ------------------------------- */
export async function apiVendorJobs(): Promise<any[]> {
  return get<any[]>("/vendor-jobs");
}
export async function apiJobProgress(id: string, note?: string) {
  return post(`/jobs/${id}/progress`, { note });
}
export async function apiJobComplete(id: string, note?: string) {
  return post(`/jobs/${id}/complete`, { note });
}

/* --------------------------------- Compose -------------------------------- */
export async function apiComposeMessage(input: {
  target: "tenant" | "vendor";
  request: { id: string; summary: string; category?: string; priority?: string; property?: string };
  tone?: "neutral" | "friendly" | "firm";
}): Promise<{ subject: string; body: string }> {
  return post("/compose/message", input);
}

/* -------------------------------------------------------------------------- */
/* internals                                                                  */
/* -------------------------------------------------------------------------- */
function normalizePath(p: string): string {
  return p.startsWith("/") ? p : `/${p}`;
}
async function safeText(res: Response): Promise<string> {
  try {
    return await res.text();
  } catch {
    return "";
  }
}
async function safeJson(res: Response): Promise<any> {
  try {
    return await res.json();
  } catch {
    return null;
  }
}
function baseHeaders(withJson = false): Record<string, string> {
  return {
    ...(withJson ? { "Content-Type": "application/json" } : {}),
    ...(import.meta.env.VITE_API_KEY ? { "x-api-key": String(import.meta.env.VITE_API_KEY) } : {}),
  };
}
